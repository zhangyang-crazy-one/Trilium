---
alwaysApply: true
description: "重构触发规则 - 每次会话必须加载"
---

# 重构触发规则

> 加载时机：PreToolUse（使用 Read 工具读取文件后评估）
> 适用范围：检测到代码质量问题时

---

## 重构触发器

<refactoring_triggers>
当检测到代码质量问题时，**必须**向用户告警并提出解决方案。

### 文件长度违规（强制 MUST）

当文件超出长度限制时：

1. **立即**向用户告警，显示当前行数
2. 提出 **1-3 个**具体的重构方案
3. **等待**用户决定后再继续

**告警格式示例**：

```
⚠️ 文件长度告警：`ComponentName.tsx` 有 350 行（限制：300 行）

建议的解决方案：
1. 将 [具体逻辑] 提取到自定义 hook `useXxx`
2. 拆分为 [ComponentA] 和 [ComponentB] 组件
3. 将 [具体工具函数] 移到单独的 utils 文件

您希望采用哪种方案？
```

### 重复代码检测（强制 MUST）

当检测到重复或高度相似的代码时：

1. 分析两个代码块的功能用途
2. 向用户告警，提供具体的文件位置和行号
3. 提出合并或删除建议，附带清晰的理由
4. **等待**用户确认后再重构

**告警格式示例**：

```
⚠️ 重复代码检测

发现位置：
- `src/components/UserList.tsx` (行 45-67)
- `src/components/ProductList.tsx` (行 32-54)

功能分析：两处代码都实现了分页逻辑

建议：
1. 提取为通用 hook `usePagination`
2. 创建通用 `PaginatedList` 组件

您希望如何处理？
```

### 过时依赖检测（强制 MUST）

当遇到过时的依赖或废弃的 API 时：

1. 向用户告警过时的包/API
2. 提供迁移路径（如果可用）
3. 说明任何破坏性变更或安全影响
4. **永远不要**在没有用户批准的情况下静默更新

**告警格式示例**：

```
⚠️ 废弃 API 检测

`moment.js` 已进入维护模式，建议迁移到 `date-fns` 或 `dayjs`

迁移路径：
1. 安装 `date-fns`: npm install date-fns
2. 替换 `moment().format('YYYY-MM-DD')` 为 `format(new Date(), 'yyyy-MM-dd')`

是否需要我协助迁移？
```

### 深度嵌套代码（强制 MUST）

当代码嵌套超过 4 层时：

1. 向用户告警深度嵌套的部分
2. 提出提取到单独函数的建议
3. 建议使用提前返回或守卫子句（适用时）

**告警格式示例**：

```
⚠️ 深度嵌套告警：`processOrder.ts` 行 120-180（嵌套深度：5 层）

建议的重构：
1. 使用提前返回减少嵌套：
   if (!isValid) return;
   
2. 提取内部逻辑到独立函数：
   const validateItems = (items) => { ... };
   const calculateTotal = (items) => { ... };

您希望如何处理？
```

### 重构检查清单

在告警用户之前，确认：

```
□ 问题确实存在（不是误报）
□ 提供了具体的位置信息
□ 解决方案是可行的
□ 解释了重构的好处
□ 等待用户确认后再行动
```

### 重构原则

| 原则 | 说明 |
|------|------|
| 最小改动 | 只做必要的重构，不扩大范围 |
| 保持行为 | 重构不应改变功能行为 |
| 分步进行 | 大型重构应分步骤完成 |
| 测试覆盖 | 重构后验证测试仍然通过 |
</refactoring_triggers>
